#!/bin/bash

set -o errexit
set -o nounset
set -o pipefail

RED='\033[31m'
GREEN='\033[32m'
BLUE='\033[34m'
UNDERLINE='\033[4m'
RESET='\033[0m'

targetEnvironment="${1:-unknown}"

"@CMAKE_CURRENT_BINARY_DIR@/build-e2e" "${targetEnvironment}"

rowerProfile=$("@CMAKE_CURRENT_BINARY_DIR@/get-rower-profile" "${targetEnvironment}")

calibrationDir="@PROJECT_SOURCE_DIR@/test/calibration/${rowerProfile}"
if [[ ! -d ${calibrationDir} ]]; then
    echo -e "${RED}No calibration for rower profile: \"${rowerProfile}\"${RESET}"
    exit 1
fi

echo -e "${BLUE}${UNDERLINE}Current calibration directory:${RESET} ${calibrationDir}"

calibrationOutputDir="${calibrationDir}/output"
mkdir -p "${calibrationOutputDir}"

exitCode=0
for file in "${calibrationDir}"/*test.txt; do
  echo -e "file: $(basename "${file}")"

  "$<TARGET_FILE:e2e-test>" "${file}" > "${calibrationOutputDir}/$(basename "${file}")-output.txt"

  actualStrokeCount=$(grep -ic "power" "${calibrationOutputDir}/$(basename "${file}")-output.txt")

  expectedStrokeCount=$(echo "$(basename "${file}")" | cut -d'-' -f3)
  if [[ "${expectedStrokeCount}" == "${actualStrokeCount}" ]]; then
    passed="PASSED"
    color="${GREEN}"
  else
    passed="FAILED"
    color="${RED}"
    exitCode=1
  fi

  echo -e "number of strokes: ${actualStrokeCount} ${color}${passed}${RESET}"
done
exit ${exitCode}
